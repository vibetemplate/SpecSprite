# vibeGen架构决策记录 (ADR-001)

**标题**: 为什么vibeGen选择"双独立MCP服务"架构

**日期**: 2025-07-03

**状态**: 已决定

## 1. 背景与问题陈述

`vibeGen`的核心设计思想是**双大脑架构**：
*   **大脑A (MCP-1)**: 一个创造性的、负责与用户沟通并制定产品蓝图(`prd.json`)的"产品经理"。
*   **大脑B (MCP-2)**: 一个确定性的、负责读取蓝图并精确构建项目的"项目构建协调器"。

在产品落地时，我们面临一个核心的架构挑战：如何在为用户提供最简单安装体验的同时，完美地实现这个双大脑架构，并且不给用户带来任何额外的配置负担或API费用？

这是一个典型的"不可能三角"问题，我们试图同时实现三个互相冲突的目标：
1.  **单一安装**: 用户体验最佳，一键安装，一个进程。
2.  **双脑架构**: 功能实现最优，创造性与确定性工作完全分离。
3.  **零额外成本**: 用户门槛最低，无需配置或支付额外的LLM API Key。

## 2. 备选方案探索及否决原因

在决策过程中，我们深入探讨了多种看似可行的方案，但经过严格的现实性分析后，均予以否决。

### 2.1. 方案一: DXT统一封装 (理论上的完美方案)

*   **描述**: 将两个独立的MCP服务打包进一个`.dxt`扩展包中，由宿主IDE（如Cursor）一键安装并自动在后台启动两个服务。
*   **否决原因**: **不具备可行性。** DXT是一个由Anthropic提出的、极具前瞻性的规范，但它**目前仍处于推广阶段，并未被Cursor或任何主流IDE正式支持**。我们的产品架构不能建立在一个尚未落地的技术愿景之上。

### 2.2. 方案二: 单一服务，内部调用外部API (最伤害用户的方案)

*   **描述**: 创建一个单一的`vibeGen`服务器。在执行MCP-1的创造性任务时，由服务器**内部直接调用外部的大模型API**（如Claude API, OpenAI API等）。
*   **否决原因**: **用户成本和配置门槛过高。** 这个方案将成本转嫁给了用户，要求他们：
    1.  自己去申请一个或多个大模型API Key。
    2.  为这些API Key的使用付费。
    3.  在`vibeGen`的配置中正确填写这些Key。
    这是产品设计上的重大缺陷，会**极大地阻碍产品的推广和用户接受度**。

### 2.3. 方案三: 单一服务，通过`sampling`借用宿主能力 (技术上不可行的方案)

*   **描述**: 创建一个单一的`vibeGen`服务器。在需要LLM能力时，通过MCP协议中的`sampling`功能，向宿主IDE（Cursor）**请求AI补全**，从而"借用"用户已配置好的LLM。
*   **否决原因**: **宿主环境不支持。** 经官方文档查证，MCP的`sampling`功能是一个非常新的特性，**连Anthropic自家的Claude桌面端都尚未支持**。我们无法假设Cursor会支持一个连协议提出方都未完全实现的功能。依赖此方案将导致项目无法开发。

---

## 3. 最终决策：双独立MCP服务

经过对所有备选方案的审慎评估，我们最终决定采用**方案B：双独立MCP服务**。

### 3.1. 架构描述

*   **`prd-generator` (MCP-1)**: 一个**标准**的MCP服务器。它向宿主IDE（Cursor）注册`generate_prd`等工具。当它需要进行复杂的推理和对话时，它会向Cursor**请求LLM补全**，这会**自动使用用户在Cursor中已经配置好的Claude模型**。这是标准的、受支持的MCP工作模式。
*   **`code-generator` (MCP-2)**: 第二个**独立**的MCP服务器。它是一个**非LLM的、确定性的构建器**。它向Cursor注册`build_project`等工具，在接收到`prd.json`后，通过调用Cursor提供的文件操作工具（如`edit_file`）来完成项目构建。

### 3.2. 决策理由：为何此方案胜出？

此方案是我们唯一能在"不可能三角"中找到的最佳平衡点，它做出了最明智的取舍：

1.  **✅ 实现了零额外成本**: 这是**最关键的优势**。用户无需任何额外的API Key，无需任何额外的费用。`vibeGen`开箱即用，与用户现有的Cursor环境无缝集成。这**最大程度地降低了用户的使用门槛**。
2.  **✅ 实现了双脑架构**: 我们在逻辑和物理上都保持了两个"大脑"的完全独立，确保了架构的纯粹性和各自职责的清晰，这是实现高质量输出的保证。
3.  **✅ 保证了技术可行性**: 此方案使用的所有协议和功能，都是当前MCP规范中成熟、稳定且被主流宿主（如Cursor）广泛支持的部分。**这个方案今天就可以开始开发**。
4.  **妥善处理了"单一安装"问题**: 我们承认，让用户启动两个服务是体验上的一个妥协。但这个问题可以通过提供一个简单的启动脚本（如`start-vibegen.sh`或`run.bat`）来极大缓解，将用户的操作简化为**执行一个命令**。相比于要求用户申请和配置API Key的巨大痛苦，这个小小的妥协是完全值得的。

## 4. 结论

**双独立MCP服务**架构，是`vibeGen`在当前技术生态下，唯一能够同时满足**功能先进性、用户零成本和技术可行性**的方案。它是一个深思熟虑后，优先考虑**消除用户核心痛点（额外成本与配置）**的务实且强大的工程决策。 